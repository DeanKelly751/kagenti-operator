apiVersion: v1
kind: ServiceAccount
metadata:
  name: weather-agent-sa
  namespace: agents
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: weather-agent
  namespace: agents
  labels:
    kagenti.io/type: agent
    kagenti.io/protocol: a2a
spec:
  replicas: 1
  selector:
    matchLabels:
      app: weather-agent
  template:
    metadata:
      labels:
        app: weather-agent
        kagenti.io/type: agent
        kagenti.io/protocol: a2a
    spec:
      serviceAccountName: weather-agent-sa
      initContainers:
        - name: sign-agentcard
          image: kagenti/agentcard-signer:latest
          env:
            - name: SPIFFE_ENDPOINT_SOCKET
              value: unix:///run/spire/sockets/agent.sock
            - name: UNSIGNED_CARD_PATH
              value: /etc/agentcard/agent.json
            - name: AGENT_CARD_PATH
              value: /app/.well-known/agent.json
          volumeMounts:
            - name: spire-agent-socket
              mountPath: /run/spire/sockets
              readOnly: true
            - name: unsigned-card
              mountPath: /etc/agentcard
              readOnly: true
            - name: signed-card
              mountPath: /app/.well-known
          securityContext:
            runAsNonRoot: true
            runAsUser: 65534
            readOnlyRootFilesystem: true
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            seccompProfile:
              type: RuntimeDefault
          resources:
            requests:
              cpu: 10m
              memory: 16Mi
            limits:
              cpu: 100m
              memory: 32Mi
      containers:
        - name: weather-agent
          image: weather-agent:latest
          ports:
            - containerPort: 8080
          volumeMounts:
            - name: signed-card
              mountPath: /app/.well-known
              readOnly: true
      volumes:
        - name: spire-agent-socket
          csi:
            driver: "csi.spiffe.io"
            readOnly: true
        - name: unsigned-card
          configMap:
            name: weather-agent-card-unsigned
        - name: signed-card
          emptyDir:
            medium: Memory
            sizeLimit: 1Mi
---
apiVersion: v1
kind: Service
metadata:
  name: weather-agent
  namespace: agents
spec:
  selector:
    app: weather-agent
  ports:
    - port: 8080
      targetPort: 8080
