apiVersion: v1
kind: ServiceAccount
metadata:
  name: weather-agent-sa
  namespace: agents
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: weather-agent-card-unsigned
  namespace: agents
data:
  agent.json: |
    {
      "name": "Weather Agent",
      "description": "Provides weather forecasts and current conditions",
      "url": "http://weather-agent.agents.svc.cluster.local:8080",
      "version": "1.0.0",
      "capabilities": {
        "streaming": false,
        "pushNotifications": false
      },
      "defaultInputModes": ["text/plain"],
      "defaultOutputModes": ["text/plain"],
      "skills": [
        {
          "name": "get_weather",
          "description": "Get current weather for a location",
          "inputModes": ["text/plain"],
          "outputModes": ["text/plain"]
        }
      ]
    }
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: weather-agent
  namespace: agents
  labels:
    kagenti.io/type: agent
    kagenti.io/protocol: a2a
    app.kubernetes.io/name: weather-agent
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: weather-agent
      kagenti.io/type: agent
  template:
    metadata:
      labels:
        app.kubernetes.io/name: weather-agent
        kagenti.io/type: agent
        kagenti.io/protocol: a2a
    spec:
      serviceAccountName: weather-agent-sa
      initContainers:
        - name: sign-agentcard
          # Local/Kind: kagenti/agentcard-signer:latest (make build-signer && make load-signer-image)
          # Remote:     push to a registry accessible by your cluster (e.g. ttl.sh, ghcr.io)
          image: kagenti/agentcard-signer:latest
          imagePullPolicy: IfNotPresent
          env:
            - name: SPIFFE_ENDPOINT_SOCKET
              value: unix:///run/spire/agent-sockets/spire-agent.sock
            - name: UNSIGNED_CARD_PATH
              value: /etc/agentcard/agent.json
            - name: AGENT_CARD_PATH
              value: /app/.well-known/agent.json
            - name: SIGN_TIMEOUT
              value: "30s"
          volumeMounts:
            - name: spire-agent-socket
              mountPath: /run/spire/agent-sockets
              readOnly: true
            - name: unsigned-card
              mountPath: /etc/agentcard
              readOnly: true
            - name: signed-card
              mountPath: /app/.well-known
          securityContext:
            runAsNonRoot: true
            readOnlyRootFilesystem: true
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
          resources:
            requests:
              cpu: 10m
              memory: 16Mi
            limits:
              cpu: 100m
              memory: 32Mi
      containers:
        - name: agent
          image: docker.io/python:3.11-slim
          command: ["python3", "-m", "http.server", "8080", "--directory", "/app"]
          ports:
            - containerPort: 8080
          volumeMounts:
            - name: signed-card
              mountPath: /app/.well-known
              readOnly: true
      volumes:
        - name: spire-agent-socket
          csi:
            driver: csi.spiffe.io
            readOnly: true
        - name: unsigned-card
          configMap:
            name: weather-agent-card-unsigned
        - name: signed-card
          emptyDir:
            medium: Memory
            sizeLimit: 1Mi
---
apiVersion: v1
kind: Service
metadata:
  name: weather-agent
  namespace: agents
spec:
  selector:
    app.kubernetes.io/name: weather-agent
  ports:
    - port: 8080
      targetPort: 8080
